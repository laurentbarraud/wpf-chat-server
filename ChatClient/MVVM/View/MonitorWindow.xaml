<Window
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:helpers="clr-namespace:ChatClient.Helpers"
    xmlns:av="http://schemas.microsoft.com/expression/blend/2008" 
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="av" 
    x:Name="MonitorWindow1"
    xmlns:vm="clr-namespace:ChatClient.MVVM.ViewModel"
    x:Class="ChatClient.MVVM.View.MonitorWindow"
    Title="{Binding MonitorWindowTitle}"
    Height="440" Width="498"
    ShowInTaskbar="False"
    ResizeMode="NoResize"
    WindowStartupLocation="Manual"
    Background="{DynamicResource BackgroundBrush}"
    Icon="/Resources/monitor-icon.ico"
    TabIndex="12"
    MinHeight="300"
    MinWidth="438"
    Closed="MonitorWindow1_Closed">

    <!-- Main Grid -->
    <Grid Margin="0,0,0,0">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <!-- Settings -->
            <RowDefinition Height="Auto"/>
            <!-- Validate button -->
            <RowDefinition Height="Auto"/>
            <!-- About link -->
        </Grid.RowDefinitions>

        <!-- Displayed instead of the datagrid -->
        <TextBlock Grid.Row="0"
               Text="{Binding MaskMessage}"
               Visibility="{Binding IsMaskVisible, Converter={StaticResource BoolToVisibilityConverter}}"
               HorizontalAlignment="Center"
               VerticalAlignment="Center"
               FontSize="16"
               TextAlignment="Center"
               TextWrapping="Wrap"
               Margin="20"
               Foreground="{DynamicResource PrimaryBrush}" />

        <!-- Public Keys DataGrid -->
        <DataGrid x:Name="PublicKeysDataGrid"
                  Grid.Row="0"
                  ItemsSource="{Binding EncryptionPipeline.KnownPublicKeys}"
                  Visibility="{Binding IsGridVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                  ColumnWidth="*"
                  AutoGenerateColumns="False"
                  HeadersVisibility="Column"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  CanUserResizeRows="False"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="False"
                  Background="{DynamicResource BackgroundBrush}"
                  Foreground="{DynamicResource ForegroundBrush}"
                  BorderThickness="0"
                  RowHeaderWidth="0"
                  SelectionMode="Single"
                  SelectionUnit="FullRow"
                  IsReadOnly="True">

            <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                    <Setter Property="Background" Value="{DynamicResource BackgroundBrush}"/>

                    <Style.Triggers>
                        <!-- Highlights the local key row -->
                        <DataTrigger Binding="{Binding IsLocal}" Value="True">
                            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.RowStyle>

            <DataGrid.Columns>

                <!-- COLUMN 1 : Username -->
                <DataGridTextColumn Header="{Binding UsernameHeader}"
                                    Binding="{Binding Username}"
                                    Width="4.5*" />

                <!-- COLUMN 2 : Key excerpt -->
                <DataGridTemplateColumn Header="{Binding KeyExcerptHeader}"
                                        Width="2*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding KeyExcerpt}"
                                   Foreground="#82AFBD"
                                   FontFamily="Consolas"
                                   VerticalAlignment="Center"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- COLUMN 3 : Status (text and icon) -->
                <DataGridTemplateColumn Header="{Binding StatusHeader}" 
                                        Width="2*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>

                            <StackPanel Orientation="Horizontal"
                                    VerticalAlignment="Center">

                                <TextBlock Text="{Binding StatusText}"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       VerticalAlignment="Center"/>

                                <Image Width="16" Height="16"
                                   VerticalAlignment="Center">
                                    <Image.Style>
                                        <Style TargetType="Image">
                                            <Setter Property="Source" Value="/Resources/invalid.png"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsValid}" Value="True">
                                                    <Setter Property="Source" Value="/Resources/valid-key.png"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Image.Style>
                                </Image>

                            </StackPanel>

                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- COLUMN 4 : Action button -->
                <DataGridTemplateColumn Header="{Binding ActionHeader}"
                                        Width="1.5*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>

                            <Button Width="24" Height="24"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Command="{Binding DataContext.RequestMissingPublicKeyCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                    CommandParameter="{Binding UID}">
                                    <!-- Pass row UID to the window ViewModel command -->

                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Visibility" Value="Collapsed"/>

                                        <Setter Property="Content">
                                            <Setter.Value>
                                                <Image Source="/Resources/pull-missing-public-key.png"
                                                   Width="24" Height="24"/>
                                            </Setter.Value>
                                        </Setter>

                                        <Style.Triggers>

                                            <!-- Always hide for local key -->
                                            <DataTrigger Binding="{Binding IsLocal}" Value="True">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>

                                            <!-- Show only if missing AND not local -->
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsLocal}" Value="False"/>
                                                    <Condition Binding="{Binding IsMissing}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>

                                        </Style.Triggers>

                                    </Style>
                                </Button.Style>

                            </Button>

                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

            </DataGrid.Columns>
        </DataGrid>

        <!-- Validate button -->
        <Button Grid.Row="1"
            Background="{DynamicResource AccentBrush}"
            IsDefault="True"
            IsCancel="True"
            Click="CmdValidate_Click"
            Width="60"
            Height="32"
            TabIndex="6"
            Margin="0,2,0,8"
            HorizontalAlignment="Center">
            <Image Source="/Resources/validate.png" Stretch="Uniform"/>
        </Button>
   
    </Grid>

</Window>
